<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Livestream</title>
  <link rel="stylesheet" href="layout.css" />
</head>
<body>
  <!-- Toolbar (Editor Mode) -->
  <div id="toolbar" class="toolbar">
    <span class="label">Room:</span>
    <span id="roomId" style="font-weight:bold; color:#fff;"></span>

    <button id="addText" title="Add Text Box">Add Text</button>
    <div id="text-tools">
      <span class="label">Format:</span>
      <button id="boldBtn"   title="Bold"><b>B</b></button>
      <button id="underlineBtn" title="Underline"><u>U</u></button>
      <button id="bulletBtn" title="â€¢ List">&bull; List</button>
      <button id="numberBtn" title="1. List">1. List</button>
    </div>

    <button id="castTab"   title="Cast Your Tab">Cast Tab</button>
    <button id="addCam"    title="Add Webcam PiP">Add Cam</button>
    <label class="label" for="imgUpload">Image:</label>
    <input type="file" id="imgUpload" accept="image/*" title="Upload Image" />
    <label class="label" for="vidUpload">Video:</label>
    <input type="file" id="vidUpload" accept="video/*" title="Upload Video" />

    <button id="micToggle" title="Toggle Mic">Mic On/Off</button>
    <label class="label" for="micVol">Mic Vol:</label>
    <input type="range" id="micVol" min="0" max="2" step="0.01" value="1" />
    <label class="label" for="tabVol">Tab Vol:</label>
    <input type="range" id="tabVol" min="0" max="2" step="0.01" value="1" />
    <label class="label" for="mixVol">Mix Vol:</label>
    <input type="range" id="mixVol" min="0" max="2" step="0.01" value="1" />

    <button id="start"    title="Start Streaming">Start</button>
    <button id="stop"     title="Stop Streaming">Stop</button>
    <button id="copyURL"  title="Copy Viewer Link">Copy URL</button>
    <a id="viewLink" href="#" title="View Stream">View Stream</a>

    <button id="exportLayout" title="Export Layout">Export</button>
    <input type="file" id="importLayout" title="Import Layout" />

    <img
      class="company-logo"
      src="https://avatars.githubusercontent.com/oa/3033067?s=240&u=00ea87da3687ce9135fac4ae4cf569eb7179885d&v=4"
      alt="Logo"
      title="Livestream"
    />
  </div>

  <!-- Editor Canvas -->
  <div id="canvas"></div>

  <!-- Viewer Area -->
  <div id="viewer" hidden>
    <h2 style="position:absolute; top:60px; left:50%; transform:translateX(-50%); color:#222;">
      ðŸ‘€ Viewing Room <span id="viewRoomId" style="font-weight:bold;"></span>
    </h2>
    <video id="player" controls autoplay></video>
    <div class="orb" style="top:20%; left:15%; animation-delay:0s;"></div>
    <div class="orb" style="top:60%; left:40%; animation-delay:1s;"></div>
    <div class="orb" style="top:30%; left:70%; animation-delay:2.5s;"></div>
  </div>

  <!-- Libs & Socket.io -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  ;(function() {
    const params = new URLSearchParams(location.search);
    const room   = params.get('room') || '';
    const view   = params.get('view') === '1';
    const origin = location.origin;

    // Display room codes
    document.getElementById('roomId').innerText     = room;
    document.getElementById('viewRoomId')?.innerText = room;

    // Toggle Editor vs Viewer
    document.getElementById('toolbar').hidden = view;
    document.getElementById('canvas').hidden  = view;
    document.getElementById('viewer').hidden  = !view;

    // Setup copy & view link
    document.getElementById('copyURL').onclick = () => {
      const url = `${origin}/?room=${room}&view=1`;
      navigator.clipboard.writeText(url);
      alert('Viewer link copied:\n' + url);
    };
    document.getElementById('viewLink').href = `/?room=${room}&view=1`;

    // Viewer mode: play incoming chunks
    if (view) {
      const socket = io({ query: { room } });
      const player = document.getElementById('player');
      const ms     = new MediaSource();
      let sb;
      player.src = URL.createObjectURL(ms);
      ms.addEventListener('sourceopen', () => {
        sb = ms.addSourceBuffer('video/webm; codecs="vp8, opus"');
        socket.on('stream-chunk', chunk => {
          const r = new FileReader();
          r.onload = () => sb.appendBuffer(r.result);
          r.readAsArrayBuffer(chunk);
        });
      });
      return;
    }

    // â€”â€” Editor Mode â€”â€”  
    const socket = io({ query: { room } });
    const ctx    = new AudioContext();
    let micNode, tabNode;

    // InteractJS helper
    function enableInteract(el) {
      interact(el)
        .draggable({
          onstart() { el.classList.add('dragging'); },
          onmove(e) { dragMove(e); },
          onend()   { el.classList.remove('dragging'); }
        })
        .resizable({
          edges: { left:true, right:true, top:true, bottom:true },
          onmove(e) { resizeMove(e); }
        })
        .gesturable({ onmove(e) { rotateMove(e); } });
    }
    function dragMove(e) {
      const t = e.target;
      const x = (parseFloat(t.dataset.x)||0) + e.dx;
      const y = (parseFloat(t.dataset.y)||0) + e.dy;
      t.style.transform = `translate(${x}px,${y}px) rotate(${t.dataset.rot||0}deg)`;
      t.dataset.x = x; t.dataset.y = y;
    }
    function resizeMove(e) {
      const el = e.target;
      el.style.width  = e.rect.width + 'px';
      el.style.height = e.rect.height + 'px';
      dragMove(e);
    }
    function rotateMove(e) {
      const el  = e.target;
      const rot = (parseFloat(el.dataset.rot)||0) + e.da;
      el.dataset.rot = rot;
      el.style.transform = `translate(${el.dataset.x||0}px,${el.dataset.y||0}px) rotate(${rot}deg)`;
    }

    // Text formatting tools
    const cmds = ['bold','underline','insertUnorderedList','insertOrderedList'];
    const btns = ['boldBtn','underlineBtn','bulletBtn','numberBtn'];
    btns.forEach((id,i) => {
      document.getElementById(id).onclick = () => document.execCommand(cmds[i]);
    });
    document.body.addEventListener('click', e => {
      const active = e.target.classList.contains('text-box');
      document.getElementById('text-tools').style.display = active ? 'flex' : 'none';
      active && e.target.focus();
    });

    // Add new text box
    document.getElementById('addText').onclick = () => {
      const tb = document.createElement('div');
      tb.contentEditable = true;
      tb.className = 'draggable text-box';
      tb.innerText = 'Edit meâ€¦';
      document.getElementById('canvas').append(tb);
      enableInteract(tb);
      setTimeout(() => {
        tb.focus();
        document.getElementById('text-tools').style.display = 'flex';
      }, 0);
    };

    // Audio & media capture
    async function connectSource(stream, setter) {
      const srcNode = ctx.createMediaStreamSource(stream);
      const gain    = ctx.createGain();
      srcNode.connect(gain).connect(ctx.destination);
      setter({ node: gain, stream });
    }
    document.getElementById('micToggle').onclick = async () => {
      if (!micNode) {
        const s = await navigator.mediaDevices.getUserMedia({ audio:true });
        connectSource(s, o=>micNode=o);
      } else {
        micNode.stream.getTracks().forEach(t=>t.enabled=!t.enabled);
      }
    };
    document.getElementById('micVol').oninput = e => micNode && (micNode.node.gain.value = e.target.value);

    document.getElementById('castTab').onclick = async () => {
      const s = await navigator.mediaDevices.getDisplayMedia({ video:true,audio:true });
      connectSource(s, o=>tabNode=o);
      placeVideo(s);
    };
    document.getElementById('addCam').onclick = async () => {
      const s = await navigator.mediaDevices.getUserMedia({ video:true });
      placeVideo(s);
    };
    function placeVideo(stream) {
      const v = document.createElement('video');
      v.autoplay = true; v.muted = true; v.srcObject = stream;
      v.className = 'draggable';
      v.style.cssText = 'width:200px;height:150px;border:2px solid #0099ff;';
      document.getElementById('canvas').append(v);
      enableInteract(v);
    }

    // Upload image/video
    document.getElementById('imgUpload').onchange = e => {
      const f = e.target.files[0], url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url; img.className = 'draggable';
      img.style.cssText = 'width:150px;height:auto;';
      document.getElementById('canvas').append(img);
      enableInteract(img);
    };
    document.getElementById('vidUpload').onchange = e => {
      const f = e.target.files[0], url = URL.createObjectURL(f);
      const vid = document.createElement('video');
      vid.src = url; vid.controls = true; vid.autoplay = true;
      vid.className = 'draggable';
      vid.style.cssText = 'width:200px;height:150px;border:2px solid #0099ff;';
      document.getElementById('canvas').append(vid);
      enableInteract(vid);
    };

    // Record & stream
    let recorder;
    document.getElementById('start').onclick = () => {
      const dest = ctx.createMediaStreamDestination();
      if (micNode) micNode.node.connect(dest);
      if (tabNode) tabNode.node.connect(dest);
      recorder = new MediaRecorder(dest.stream, { mimeType: 'video/webm; codecs=vp8, opus' });
      recorder.ondataavailable = e => e.data.size && socket.emit('stream-chunk', e.data);
      recorder.start(250);
    };
    document.getElementById('stop').onclick = () => recorder && recorder.stop();

    // Export / Import layout
    document.getElementById('exportLayout').onclick = () => {
      const items = Array.from(document.querySelectorAll('#canvas .draggable'));
      const layout = items.map(el => ({
        tag: el.tagName,
        html: el.innerHTML,
        styles: {
          width: el.style.width,
          height: el.style.height,
          transform: el.style.transform
        },
        src: el.src || null
      }));
      const blob = new Blob([JSON.stringify(layout)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'layout.json';
      a.click();
    };
    document.getElementById('importLayout').onchange = e => {
      const reader = new FileReader();
      reader.onload = () => {
        const layout = JSON.parse(reader.result);
        const canvas = document.getElementById('canvas');
        canvas.innerHTML = '';
        layout.forEach(item => {
          const el = document.createElement(item.tag);
          if (item.src) el.src = item.src;
          el.innerHTML = item.html;
          Object.assign(el.style, item.styles);
          el.className = 'draggable';
          canvas.append(el);
          enableInteract(el);
        });
      };
      reader.readAsText(e.target.files[0]);
    };
  })();
  </script>
</body>
</html>