<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Livestream Viewer</title>
  <link rel="stylesheet" href="layout.css" />
  <style>
    /* End‚Äêscreen overlay */
    #endScreen {
      position: absolute;
      top: 48px; left: 0;
      width: 100%; height: calc(100% - 48px);
      background: linear-gradient(to bottom, #0099ff, #004466);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      opacity: 0;
      pointer-events: none;
      transition: opacity 2s ease;
      z-index: 20;
    }
    #endScreen.show {
      opacity: 1;
      pointer-events: auto;
    }
    #endScreen h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .end-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .end-buttons a {
      position: relative;
      color: white;
      text-decoration: none;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border: 1px solid white;
      border-radius: 4px;
    }
    .end-buttons a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 2px;
      width: 0;
      background: white;
      transition: width 0.4s ease;
    }
    .end-buttons a:hover::after {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2 style="position:absolute; top:16px; left:16px; color:#222;">
    üëÄ Viewing Room <strong id="viewRoomId"></strong>
  </h2>
  <video id="player" controls autoplay style="width:80%;max-width:800px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #0099ff;background:black;"></video>
  <div class="orb" style="top:20%; left:15%; animation-delay:0s;"></div>
  <div class="orb" style="top:60%; left:40%; animation-delay:1s;"></div>
  <div class="orb" style="top:30%; left:70%; animation-delay:2.5s;"></div>

  <!-- End-of-stream screen -->
  <div id="endScreen">
    <h1>Looks like we‚Äôre done here!<br />See you next time!</h1>
    <div class="end-buttons">
      <a href="/">Return Home</a>
      <a href="/">Start New Stream</a>
      <a href="https://github.com/camcookie876/live-2025" target="_blank">View on GitHub</a>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  ;(function() {
    const params = new URLSearchParams(location.search);
    const room   = params.get('room') || '';
    document.getElementById('viewRoomId').innerText = room;

    const socket = io({ query: { room } });
    const player = document.getElementById('player');
    const ms     = new MediaSource();
    let sb;

    player.src = URL.createObjectURL(ms);
    ms.addEventListener('sourceopen', () => {
      sb = ms.addSourceBuffer('video/webm; codecs="vp8, opus"');
      socket.on('stream-chunk', chunk => {
        const r = new FileReader();
        r.onload = () => sb.appendBuffer(r.result);
        r.readAsArrayBuffer(chunk);
      });
    });

    // When stream ends, show end screen
    player.addEventListener('ended', () => {
      // fade video & orbs
      document.querySelectorAll('video, .orb').forEach(el => {
        el.style.transition = 'opacity 1s';
        el.style.opacity = '0';
      });
      // remove ?room=‚Ä¶ from URL
      history.replaceState(null, '', window.location.pathname);
      // reveal overlay
      setTimeout(() => {
        document.getElementById('endScreen').classList.add('show');
      }, 1000);
    });
  })();
  </script>
</body>
</html>